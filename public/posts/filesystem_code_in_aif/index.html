<!DOCTYPE html>
<html lang="en-us"><head><meta charset="utf-8">
<meta http-equiv="content-type" content="text/html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">


<title itemprop="name">Filesystem code in AIF | Dieter&#39;s blog</title>

<meta property="og:title" content="Filesystem code in AIF | Dieter&#39;s blog" />
<meta name="twitter:title" content="Filesystem code in AIF | Dieter&#39;s blog" />
<meta itemprop="name" content="Filesystem code in AIF | Dieter&#39;s blog" />
<meta name="application-name" content="Filesystem code in AIF | Dieter&#39;s blog" />
<meta property="og:site_name" content="" />

<meta name="description" content="">
<meta itemprop="description" content="" />
<meta property="og:description" content="" />
<meta name="twitter:description" content="" />

<meta property="og:locale" content="en-us" />
<meta name="language" content="en-us" />



  <meta itemprop="image" content="http://localhost:1313" />
  <meta property="og:image" content="http://localhost:1313" />
  <meta name="twitter:image" content="http://localhost:1313" />
  <meta name="twitter:image:src" content="http://localhost:1313" />




    
    
    
    

    <meta property="og:type" content="article" />
    <meta property="og:article:published_time" content=2010-12-08T12:24:03-0400 />
    <meta property="article:published_time" content=2010-12-08T12:24:03-0400 />

    

    

    <script defer type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "Article",
        "headline": "Filesystem code in AIF",
        "author": {
        "@type": "Person",
        "name": ""
        },
        "datePublished": "2010-12-08",
        "description": "",
        "wordCount":  1794 ,
        "mainEntityOfPage": "True",
        "dateModified": "2010-12-08",
        "image": {
        "@type": "imageObject",
        "url": ""
        },
        "publisher": {
        "@type": "Organization",
        "name": "Dieter\u0027s blog"
        }
    }
    </script>


<meta name="generator" content="Hugo 0.122.0">

    

    <link rel="canonical" href="http://localhost:1313/posts/filesystem_code_in_aif/">
    <link href="/style.min.18927ce2d0dc33c991e188f9b4efd25929b9589151125f809e2b3f45e447e971.css" rel="stylesheet">
    <link href="/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css" rel="stylesheet">

    
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg">
    <link rel="shortcut icon" href="/favicon.ico">




<link rel="manifest" href="http://localhost:1313/site.webmanifest">

<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="msapplication-TileColor" content="#2d89ef">
<meta name="theme-color" content="#434648">

    
    <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">

    
    </head>
<body data-theme = "" class="notransition">

<script src="/js/theme.min.8961c317c5b88b953fe27525839672c9343f1058ab044696ca225656c8ba2ab0.js" integrity="sha256-iWHDF8W4i5U/4nUlg5ZyyTQ/EFirBEaWyiJWVsi6KrA="></script>

<div class="navbar" role="navigation">
    <nav class="menu" aria-label="Main Navigation">
        <a href="http://localhost:1313/" class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" 
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
stroke-linejoin="round" class="feather feather-home">
<title>Home</title>
<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
<polyline points="9 22 9 12 15 12 15 22"></polyline>
</svg>
        </a>
        <input type="checkbox" id="menu-trigger" class="menu-trigger" />
        <label for="menu-trigger">
            <span class="menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentColor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7L3.40726 7"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488L3.49301 3.51488"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"></path><path stroke-linecap="round" stroke-linejoin="round" d="M0.5 12.5V1.5C0.5 0.947715 0.947715 0.5 1.5 0.5H12.5C13.0523 0.5 13.5 0.947715 13.5 1.5V12.5C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C0.947715 13.5 0.5 13.0523 0.5 12.5Z"></path></svg>
            </span>
        </label>

        <div class="trigger">
            <ul class="trigger-container">
                
                
                <li>
                    <a class="menu-link " href="/">
                        Home
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link active" href="/posts/">
                        Posts
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/projects/">
                        Projects
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/about/">
                        About
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/talks/">
                        Talks
                    </a>
                    
                </li>
                
                <li class="menu-separator">
                    <span>|</span>
                </li>
                
                
            </ul>
            <a id="mode" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
            </a>
        </div>
    </nav>
</div>

<div class="wrapper post">
    <main class="page-content" aria-label="Content">
        <article>
            <header class="header">
                <h1 class="header-title">Filesystem code in AIF</h1>
                
                
                <div class="post-meta">
                    <time datetime="2010-12-08T12:24:03-04:00" itemprop="datePublished"> 8 Dec 2010 </time>
                </div>
                
            </header>
            
            <div class="page-content">
                <p>In light of the work and discussions around supporting Nilfs2 and Btrfs on Arch Linux and its installer AIF,<br />
I've shared some <a href="http://mailman.archlinux.org/pipermail/arch-releng/2010-December/001310.html">AIF filesystem code design insights and experiences</a> on the arch-releng mailing list.<br />
This is some hard to understand code.  Partly because it's in bash (and I've needed to work around some limitations in bash),<br />
partly because there is some complex logic going on.</p>
<p>I think it's very useful material for those who are interested (it can also help understanding the user aspect),<br />
so I wanted to share an improved version here.<br />
On a related topic: I proposed to do a session at <a href="http://www.fosdem.org">Fosdem 2011/"distro miniconf"</a> about simple (console based) installers for Linux,<br />
and how multiple distributions could share efforts maintaining installation tools, because there are a lot of cross-distribution concerns<br />
which are not trivial to get right (mostly filesystems, but I also think about clock adjustments, bootloaders, etc).<br />
Already several distro's use the (or a fork of) the Arch installer, for example <a href="http://pentoo.blogspot.com/2010/10/pentoo-installation-made-easy.html">Pentoo</a>,<br />
but I think cooperation could be much better and more efficient.</p>
<p>Anyway:<br />
<br />
my acronyms for this text:</p>
<ul>
<li>LV = lvm2 Logical Volume</li>
<li>VG = lvm2 Volume Group</li>
<li>PV = lvm2 Physical Volume</li>
<li>DM = Device Mapper</li>
<li>BD = Block Device</li>
<li>FS = File System</li>
<li>DF = DeviceFile</li>
</ul>
<p>"Normal" FS'es ("do something on the BD represented by DF /dev/foo, so that you can then call `mount /dev/foo $somedir`") are <em>trivial</em> to add to aif.<br />
Basically you just need to tell aif the name of the filesystem, and which commands and arguments it needs to invoke to create it and add a label to it.<br />
Nilfs2 falls in this category.  So do ext2/3/4, xfs, jfs, reiserfs, etc.  (Nilfs is now supported and new <a href="http://build.archlinux.org/isos/">archiso testbuilds</a> are available)</p>
<p>"Complex" FS'es (which yield a new DF for a DM BD, which can span multiple underlying BD's, etc) are more difficult, and I'll explain why.<br />
Btrfs falls in this category.  So do LVM, dm_crypt and softraid.  In aif terminology anything you put on top of a BD is a FS.  This is not always technically correct, but it's not far-fetched and avoids needless complication.  For example softraid would be a FS you put on top of one or more BD's, and which itself yields a new BD on top of which you can put something else.<br />
In the same way I call a VG a FS being applied on top of a PV BD, which itself results in a new BD which can host multiple LV FS'es, which in return yield new BD's which can host other FS'es.  Currently AIF provides support for lvm and dm_crypt, but not softraid or Btrfs.</p>
<p>How aif works is this: it uses a "model" that represents how your DF/FS structure will look like.<br />
I personally usually configure my hard disk like this:<br />
a boot partition, and a partition on which i do dm_crypt, which results in a DM BD, which I make a PV, then put a VG on<br />
it, which contains multiple LV's, one for swap, and two containing<br />
some FS'es which get mounted as / and /home.</p>
<p>You can see that model on the bottom ($BLOCKDATA) of <a href="https://github.com/Dieterbe/aif/blob/master/examples/fancy-install-on-sda">the example file "fancy-install-on-sda" for automatic installations, included with aif</a>.</p>
<p>You might have noticed in the installer - if you do it interactively - how you first configure all<br />
your filesystems in the dialog interface, but only after confirming, it<br />
does all the required actions, step by step.  Actually the dialog-based configuration helper will just generate a textfile in the same format as $BLOCKDATA and the processing code is the same for interactive and automatic installs.<br />
Since in the config file for an automatic install you could define your FS's in abitrary order, aif<br />
figures out the dependencies and processes things in the right order.<br />
With the example given above aif will parse the text and will figure out the order of creation: first partition (obviously), then create the dm_crypt, then the PV, then the VG,<br />
then the LV's, then the FS'es on those LV's)<br />
then mount all mountpoints in the right order (first /, then /home and /boot)<br />
On rollback (when user changes his mind, an error occured - usually because of misconfiguration like a too big LV) everything I just explained happens in reverse.<br />
This allows users to tune their config (or try something completely different), without the installer breaking with errors like "This device is already marked as encrypted" or "VG already exists"</p>
<p>I choose this model-based approach initially because I wanted to get rid<br />
of the ugly, hacky original installer code, but still provide a lot of<br />
control through the nice dialog interfaces.  And interfaces that work fast (not causing you to wait between every step because it's creating the FS you just defined).<br />
Perhaps most importantly, since my main goal was automautic installs where you could just specify how you wanted your<br />
FS/BD structure to look like (not a series of commands), relatively little extra code was needed.  (this is also what separates AIF from FAI&amp;debian installer.  On Debian the interactive and automatic installers are different projects.  On Arch they are just different extensions for the same codebase)</p>
<p>Advantages:</p>
<ul>
<li>provides some abstraction, it's trivial to support for new (simple) filesystems.</li>
<li>makes dialog-based "configurator" easier, because we can share code with the automated installer</li>
<li>the descriptive style of the config makes it easier (although the actual format could be further improved).<br />
 definitely easier then running/writing a series of commands (resp. interactive, automatic install).<br />
 if we would make users run/write a series of commands, we also couldn't support automatic rollbacks in case of failures.</i>
</ul>
<p>Disadvantages:</p>
<ul>
<li>the more control you want to give users, the more you're just putting<br />
  effort in wrapping commandline arguments in fancy dialog interfaces<br />
  (although there is also a textbox where you can enter which ever<br />
  additional arguments you want, so this is a compromise)</li>
<li>pretty hard to implement fancier filesystems, you usually need to<br />
  take the common use cases. (see next point)</li>
<li>bash datastructures are very limited. it's not easy to translate this model in a<br />
  datastructure.  If in "FS on top of a BD" the FS is a child, and the BD a parent, it would be like a tree,<br />
  but each node could have multiple children and multiple parents, i.e. a graph.<br />
  For now I choose to ignore the "multiple parents" clause.<br />
  Currently the only implication in aif is that you cannot have a VG which consumes multiple PV's.<br />
  This is rare enough to justify this simplification, but still quite some code is needed to update and parse text files<br />
  to mimic the datastructure, although I do consider using a specific<br />
  optimized text format and an external tool to update/query the data. (yaml?)<br />
  (See <a href="https://bugs.archlinux.org/task/15640">FS 15640</a>).<br />
  Multiple children do need to be supported (a VG can have multiple LV's. line 34 in the example file)<br />
  Implementing Softraid in this model means I need to support multiple parents, i.e. work with a graph structure.<br />
  For Btrfs, the LVM-like restrictiction (no multiple physical volumes for the same FS) might be an acceptable compromise</li>
<li>users cannot do their own stuff outside aif and expect to see the<br />
  results inside aif.  If the installer would execute everything in realtime,<br />
  you could detect changes being made to the system (probably not easy though)</li>
<li>since changes don't happen in realtime, the model needs to update itself to represent how<br />
the actual state <em>would</em> look like.  For example: if you just added a dm_crypt FS on a BD, we must create<br />
a new entry /dev/mapper/$label in the model</li>
<li>for PV's, you need a way to differentiate in the menu between the<br />
  real BD (the one on which you say you want to put a PV FS) and the actual PV (on which you can put VG FS's),<br />
  so aif generates an entry with the same name as the DF, but with a '+' appended to the file.<br />
  (see the example file if unclear).  Although this problem is not specific to the actual model approach,<br />
  it's more caused by my desire to present a "global interface" to the user, and not a series of wizards and dialogs</li>
<li>Rollbacks are cool, but requires some hard to maintain code, and I doubt they are used often.<br />
(also this is not really specific about the model approach taken, but still worth mentioning)</li>
</ul>
<p>Because of all this, I have sweared quite a bit over the last few<br />
years, wondering if bash really was a good choice.  But using an external tool to work with a text-base graph/tree datastructure (where nodes can have some properties) will probably remove the big nuisance.  Also, Because bash v4 has associative arrays (finally), I can clean up a bunch of other code as well.</p>
<p>I've pondered whether we should just let users do everything on the commandline (like Gentoo), or provide a minimal layer of<br />
abstraction, like provide some scripts which they can modify that setup<br />
a system in a certain way. (for example, basically a series of mkfs; mount;pacman; calls)<br />
Another alternative would be to just make the user choose between a series of "common setups" and make them answer some questions for the choosen setup.<br />
This is how the old installer did it, and afaik archboot still does it, but it doesn't scale well with more and more possibilities.<br />
Actually, aif still contains the optional "autoprepare" method, which is in fact a simple wizard for a simple setup.</p>
<p>I guess it's a tradeoff between making it easy for users and not overloading the brain of people who want to hack on the installer.<br />
The approach which afaik has always been taken by Arch is to make the installer hold the hands of the user.<br />
When creating aif, I've choosen to stick to that concept.  And frankly I still like the idea.  It may be hard to maintain,<br />
but as a user you can finish all your installs and have a lot of options, but still use very minimal keystrokes (and mental energy).</p>
<p>Like mentioned earlier, softraid hasn't been implemented yet in aif, nor btrfs.<br />
I would need to know the most common/recommended use cases, and figure out the best way to implement them.<br />
Btrfs might be relatively easy, if i can implement it like i did lvm.  But it seems like a great FS and I don't want to provide only-half-assed support for it.<br />
Either way, refactoring the datastructure is something that will needs to be done at some point, especially for softraid.</p>
<p>I hope this article was a bit understandable.  And if you have any advice, please share :)<br />
The actual blockdevices-filesystems library of AIF is here:<br />
<a href="https://github.com/Dieterbe/aif/blob/2ee11ef334983fc68352364025ba5a97d795b95e/src/core/libs/lib-blockdevices-filesystems.sh">https://github.com/Dieterbe/aif/blob/2ee11ef334983fc68352364025ba5a97d795b95e/src/core/libs/lib-blockdevices-filesystems.sh</a><br />
And the menu's are here:<br />
<a href="https://github.com/Dieterbe/aif/blob/2ee11ef334983fc68352364025ba5a97d795b95e/src/core/libs/lib-ui-interactive.sh">https://github.com/Dieterbe/aif/blob/2ee11ef334983fc68352364025ba5a97d795b95e/src/core/libs/lib-ui-interactive.sh"</a> (the most interesting functions are interactive_filesystems for the main FS menu, and interactive_filesystem which handles definition of a specific FS)</p>

            </div>
        </article></main>
</div>
<footer class="footer">
    <span class="footer_item"> </span>
    &nbsp;

    <div class="footer_social-icons">
<a href="https://github.com/Dieterbe" target="_blank" rel="noopener noreferrer me"
    title="Github">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
    </path>
</svg>
</a>
<a href="https://twitter.com/Dieter_be" target="_blank" rel="noopener noreferrer me"
    title="Twitter">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z">
    </path>
</svg>
</a>
<a href="https://linkedin.com/in/dieterplaetinck" target="_blank" rel="noopener noreferrer me"
    title="LinkedIn">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
    <rect x="2" y="9" width="4" height="12"></rect>
    <circle cx="4" cy="4" r="2"></circle>
</svg>
</a>
</div>
    <small class="footer_copyright">
        All content Â© Dieter Plaetinck, available under
        <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noreferrer noopener">CC BY 4.0</a>
    </small>

</footer>







    
    <script src="http://localhost:1313/js/main.min.4ee188e1744c19816e95a540b2650ed9f033ea0371e74eac8e717355cfca8741.js" integrity="sha256-TuGI4XRMGYFulaVAsmUO2fAz6gNx506sjnFzVc/Kh0E="></script>

    

</body>
</html>
