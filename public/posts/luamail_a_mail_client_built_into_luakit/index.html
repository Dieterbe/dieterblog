<!DOCTYPE html>
<html lang="en-us"><head><meta charset="utf-8">
<meta http-equiv="content-type" content="text/html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">


<title itemprop="name">Luamail: a mail client built into luakit | Dieter&#39;s blog</title>

<meta property="og:title" content="Luamail: a mail client built into luakit | Dieter&#39;s blog" />
<meta name="twitter:title" content="Luamail: a mail client built into luakit | Dieter&#39;s blog" />
<meta itemprop="name" content="Luamail: a mail client built into luakit | Dieter&#39;s blog" />
<meta name="application-name" content="Luamail: a mail client built into luakit | Dieter&#39;s blog" />
<meta property="og:site_name" content="" />

<meta name="description" content="">
<meta itemprop="description" content="" />
<meta property="og:description" content="" />
<meta name="twitter:description" content="" />

<meta property="og:locale" content="en-us" />
<meta name="language" content="en-us" />



  <meta itemprop="image" content="http://localhost:1313" />
  <meta property="og:image" content="http://localhost:1313" />
  <meta name="twitter:image" content="http://localhost:1313" />
  <meta name="twitter:image:src" content="http://localhost:1313" />




    
    
    
    

    <meta property="og:type" content="article" />
    <meta property="og:article:published_time" content=2011-10-02T09:28:45-0400 />
    <meta property="article:published_time" content=2011-10-02T09:28:45-0400 />

    

    

    <script defer type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "Article",
        "headline": "Luamail: a mail client built into luakit",
        "author": {
        "@type": "Person",
        "name": ""
        },
        "datePublished": "2011-10-02",
        "description": "",
        "wordCount":  1480 ,
        "mainEntityOfPage": "True",
        "dateModified": "2011-10-02",
        "image": {
        "@type": "imageObject",
        "url": ""
        },
        "publisher": {
        "@type": "Organization",
        "name": "Dieter\u0027s blog"
        }
    }
    </script>


<meta name="generator" content="Hugo 0.122.0">

    

    <link rel="canonical" href="http://localhost:1313/posts/luamail_a_mail_client_built_into_luakit/">
    <link href="/style.min.18927ce2d0dc33c991e188f9b4efd25929b9589151125f809e2b3f45e447e971.css" rel="stylesheet">
    <link href="/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css" rel="stylesheet">

    
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg">
    <link rel="shortcut icon" href="/favicon.ico">




<link rel="manifest" href="http://localhost:1313/site.webmanifest">

<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="msapplication-TileColor" content="#2d89ef">
<meta name="theme-color" content="#434648">

    
    <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">

    
    </head>
<body data-theme = "" class="notransition">

<script src="/js/theme.min.8961c317c5b88b953fe27525839672c9343f1058ab044696ca225656c8ba2ab0.js" integrity="sha256-iWHDF8W4i5U/4nUlg5ZyyTQ/EFirBEaWyiJWVsi6KrA="></script>

<div class="navbar" role="navigation">
    <nav class="menu" aria-label="Main Navigation">
        <a href="http://localhost:1313/" class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" 
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
stroke-linejoin="round" class="feather feather-home">
<title>Home</title>
<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
<polyline points="9 22 9 12 15 12 15 22"></polyline>
</svg>
        </a>
        <input type="checkbox" id="menu-trigger" class="menu-trigger" />
        <label for="menu-trigger">
            <span class="menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentColor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7L3.40726 7"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488L3.49301 3.51488"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"></path><path stroke-linecap="round" stroke-linejoin="round" d="M0.5 12.5V1.5C0.5 0.947715 0.947715 0.5 1.5 0.5H12.5C13.0523 0.5 13.5 0.947715 13.5 1.5V12.5C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C0.947715 13.5 0.5 13.0523 0.5 12.5Z"></path></svg>
            </span>
        </label>

        <div class="trigger">
            <ul class="trigger-container">
                
                
                <li>
                    <a class="menu-link " href="/">
                        Home
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link active" href="/posts/">
                        Posts
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/about/">
                        About
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/talks/">
                        Talks
                    </a>
                    
                </li>
                
                <li class="menu-separator">
                    <span>|</span>
                </li>
                
                
            </ul>
            <a id="mode" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
            </a>
        </div>
    </nav>
</div>

<div class="wrapper post">
    <main class="page-content" aria-label="Content">
        <article>
            <header class="header">
                <h1 class="header-title">Luamail: a mail client built into luakit</h1>
                
                
                <div class="post-meta">
                    <time datetime="2011-10-02T09:28:45-04:00" itemprop="datePublished"> 2 Oct 2011 </time>
                </div>
                
            </header>
            
            <div class="page-content">
                <p>Similarly to how back in 2009 there was no browser that works in a way I find sane, and I started solving that with <a href="/uzbl_a_browser_that_adheres_to_the_unix_philosophy">uzbl</a>,
now I'm fed up with the lack of an email client that works in a way I find sane.  Uzbl turned out to be a bit cumbersome for my taste, so I switched to the uzbl-inspired but more pragmatic <a href="http://luakit.org">luakit</a> browser,
which is much in the same vein, except that all configuration, extensions, event handling, programmatic input etc are done by interfacing with lua API's.
Now I want to build the "luakit of email clients".  Let me explain what's that all about...</p>

Basically the story is pretty much the same as it was with uzbl.  There are no mail clients which offer a high level of customization and interfacing possibilities.  There are some mail clients aimed at "power users" and "lightweight mail clients" like mutt/alpine/nmh etc but those are also restricted in extensibility and often crippled in terms of features.  Currently I'm using Claws-mail, which is the least sucky client I found, but it's also nowhere near what I want.

<h3>So, what do I want in a mail client?</h3>
<ul>
<li>fast and non-bloaty (of course my definition of bloat might differ from yours, for me it's a combination of run-time performance and source code elegancy)</li>
<li>minimal but efficient UI. keyboard controlled. modal interface optional but enabled by default</li>
<li>extensive customisation options</li>
<li>plain text configuration and data files, a binary format only where appropriate (like a search index or a database)</li>
<li>rendering HTML mails and rich content (images, embedded videos, flash, HTML5) properly.
(I receive fancy newsletters from companies and rich content such as news messages from rss feeds by means of <a href="/an_rss2email_fork_that_sucks_less">rss2email-xdg</a>)</li>
<li>great link following, and for external files: integration with download software, proxies, etc). I.e. "what luakit has"</li>
<li>support Unicode and attachments (mime) properly</li>
<li>play nice with window managers (window title, urgency hint, ..), support many key bindings and use UI widgets that are not a pain (i.e. no ncurses, be an X client)</li>
<li>provide a unified interface to email sending/receiving/searching</li>
<li>keep my homedir clean. Use xdg basedir spec (i.e. cache mail and search indices in $XDG_CACHE_DIR)</li>
<li>key binds to show/hide quoted text, focus unquoted text when viewing mail by default.</li>
<li>play nice with mailing lists (track all mailing lists I'm on, allow me to unsubscribe with a shortcut)</li>
<li>filtering and mail (or displaying thereof) altering: for some specific mailing lists, prepend the subject with the name of the mailing list (i.e. lists that use the List-Id header and do not rewrite subjects)</li>
<li>high level of control over the actual message that gets sent out.  I.e. allow me to change and modify all headers</li>
<li>when sending a message fails, keep it in a retry-buffer.  give me an interface to that buffer (I.e. a list of all mails which could not be sent, why not, when they'll be retried, shortcuts to retry immediately, etc)</li>
<li>allow me to define <a href="http://en.wikipedia.org/wiki/Sieve_%28mail_filtering_language%29">sieve</a> rules in my mail client configuration, and automatically update server side when needed.</li>
<li>allow me, as a user to change anything in a fine-grained way.  Some examples:
<ul>
	<li>Differentiate properly between received mails that are "definitely optional for me", and "aimed to me".  I.e. mark all mails from a mailing list low-priority, unless a 'To'/'Cc'/'Bcc' field contains any of the addresses I use to send from <i>or</i> when the mail is a reply to a mail I sent earlier (check Message-ID and mail subject)
	<li>Use a tag-based interface towards gmail.  Gmail uses tags instead of folders, which it cannot really expose properly over IMAP (it must "duplicate" the same message in multiple folders when speaking IMAP).  I want to modify my client so that for gmail accounts, it also uses tags instead of folders</li>
	<li>Use different key bindings dependent on account in use or any property such as sender of a mail message.  Example: when deleting a message, delete straight away when it has a certain spamassasin score or is an rss2email message, move to Trash otherwise.  When the message is from anyone I know (in my contact list), ask me to confirm and offer moving to an archive folder instead.</li>
	<li>When I get a mail from nagios with a critical alert, show an inotify error message containing the right information (parse the nagios mail first), and set urgent flag.  Do the same when my boss sent me a mail containing the phrase 'urgent', unless the 'To' field contains more than 20 addresses.  Give me a key bind that sends a mail containing "I'm on it!" and switch to my browser workspace and open all my monitoring pages in my browser.  Don't disturb me for any other e-mail</li>
	<li>Use bottom posting by default, but when I'm replying to mailing list foo or person bar, use top-posting instead.</li>
	<li>Display mails by default threaded by subject and date. But for my news feeds messages (which arrive on the same account!), group by sender.  maybe even categorize senders so that I can quickly delete all humorous messages from various senders/feeds if I have no time or feel guilty about slacking off</li>
</ul>
</li>
</ul>

<h3>Implementation</h3>
My first idea was to build a standalone mail client by reusing the luakit C-based host program and all bindings it exposes
(webkitGtk widget with bindings, gtk bindings, lots of lua code for menu's, keyboard control, downloading external files, proxy code, etc. very useful stuff); which would mean we supply a set of different config files for the luakit host program, along with some more lua libraries and/or bindings to C software.
<br/>But instead we choose to neatly integrate the mail client in luakit itself, which makes it easier to develop and keep up with luakit (the diff is minimal instead of extensive), and it's probably more
convenient for the user.  So we just forked the luakit project and try to do our stuff in a separate branch, adding the mail client bits in between the existing browser bits.

The good news is, so many needed things already exist, so building the client shouldn't be that much work.
I've been researching our options (and still am), this is how the list of things we'll rely on looks like so far:
<ul>
<li>HTML/rich content: webkitGtk widget provided by luakit</li>
<li>key bindings, proxy, external files downloader, link follower, ...: luakit's lua code</li>
<li>IMAP library:  <a href="https://gitorious.org/luaimap">luaimap</a></li>
<li>SMTP: <a href="http://msmtp.sourceforge.net/">msmtp</a> (could not find any suitable lua SMTP library with proper TLS/SSL support)</li>
<li>maildir/mh/other local formats: TBD</li>
<li>message parsing: TBD. we might end up writing bindings to existing C libraries, as we couldn't find a good lua library yet, and it's hard to write one</li>
<li>search: TBD</li>
</ul>

<a href="https://github.com/mason-larobina">Mason (luakit maintainer)</a> liked the idea from the start; <a href="http://sahd.lamafam.org/">Gerry (luaimap maintainer)</a> also liked the idea and joined the project right away :)

<h3>Why not uzbl-style?</h3>
Gerry asked: "why not structure the mail client like uzbl is (fast c core with shell and python around it)?"
<br/>The main lesson I learned from doing uzbl is: the very ideology-based approach of "one program for each thing" is nice in theory, but can become a hassle in practice.  The means of IPC are limited: passing command line arguments, setting environment variables, or creating your own little protocol that needs to be parsed.  Advanced constructs like loops and branches complicate things more, and when passing stuff through various processes like we did, it can be tricky to figure out how to quote your strings so that they are expanded at the right stage.  It's also hard to jump between various pieces of code; the separation between processes start to feel like real barriers.
<br/>Luakit provides lua API's, which means all extensions should be primarily written in lua (which is a burden if you don't feel like learning a new language), you can still exec any other script or program if you want to from lua however, but the API's are very fine grained, and pretty much everything is exposed,so there's lots of things you can do, but in a way that feels more robust and reliable.  And things work faster too.
<br/>I'm not that experienced yet with luakit to grasp all its downsides, but it feels more reliable.  And maybe subconsciously, the fact that luakit feels as nice as uzbl without me needing to do anything (Mason did all the hard work of writing lua bindings and writing all lua code), whereas uzbl involved lots of hard work for me, maybe that twists my perception a bit.  But not too much, I think.
<br/>The same upsides and downsides go for writing a mail client; so luakit-style seems more appropriate to me. Especially since so many libraries and components already exist, and just need to stitched together.

<h3>Show me the code already!!</h3>
We actually have a very rough, but working prototype.  Ready for you to try out.  See the <a href="http://lists.luakit.org/archive/luakit-dev/2011-September/000206.html">luakit-dev post</a> for details.
<ul>
<li><a href="https://github.com/lama7/luakit/tree/luamail">Gerry's luamail branch of luakit</a></li>
<li><a href="https://github.com/Dieterbe/luakit/tree/luamail">My luamail branch of luakit</a></li>
</ul>

            </div>
        </article></main>
</div>
<footer class="footer">
    <span class="footer_item"> </span>
    &nbsp;

    <div class="footer_social-icons">
<a href="https://github.com/Dieterbe" target="_blank" rel="noopener noreferrer me"
    title="Github">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
    </path>
</svg>
</a>
<a href="https://twitter.com/Dieter_be" target="_blank" rel="noopener noreferrer me"
    title="Twitter">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z">
    </path>
</svg>
</a>
<a href="index.xml" target="_blank" rel="noopener noreferrer me"
    title="Rss">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 11a9 9 0 0 1 9 9" />
    <path d="M4 4a16 16 0 0 1 16 16" />
    <circle cx="5" cy="19" r="1" />
</svg>
</a>
</div>
    <small class="footer_copyright">
        All content © Dieter Plaetinck, available under
        <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noreferrer noopener">CC BY 4.0</a>
    </small>

</footer>







    
    <script src="http://localhost:1313/js/main.min.4ee188e1744c19816e95a540b2650ed9f033ea0371e74eac8e717355cfca8741.js" integrity="sha256-TuGI4XRMGYFulaVAsmUO2fAz6gNx506sjnFzVc/Kh0E="></script>

    

</body>
</html>
